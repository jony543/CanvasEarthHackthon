<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) & !(IE 8)]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Serializing and deserializing strokes | WILL SDK Docs</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="http://localhost/will_docs_instance1/xmlrpc.php">
	<!--[if lt IE 9]>
	<script src="http://localhost/will_docs_instance1/wp-content/themes/will-doc/js/html5.js"></script>
	<![endif]-->

	<link rel="stylesheet" href="../../wp-content/themes/will-doc/css/style.css">
	<link rel="stylesheet" href="../../wp-content/themes/will-doc/css/accordionmenu.css">

	<script src="../../wp-content/themes/will-doc/js/jquery.min.js"></script>
	<script src="../../wp-content/themes/will-doc/js/sidebar.js"></script>

	<link rel="stylesheet" href="../../wp-content/themes/will-doc/css/highlight.css">
	<script src="../../wp-content/themes/will-doc/js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
	<header>
		<div class="title">
			<div>WILL &trade;</div>
			<div>sdk documentation</div>
		</div>
		<!--
		<div id="searchbox">
			<input class="typeahead" type="text" placeholder="{{ search_text }}">
		</div>
-->
	</header>

	<div id="sitewrapper">
<div id="sidebar">
	<nav class="accordion">

				<h1 class="do-not-cause-collapse" title="General Concepts">

			General Concepts
			</h1>

							<div class="active-menu never-close">
					<h2 class="not-collapsible" title="Architectural Overview">

								<a href="../../general-concepts/architecture/index.html"
											>Architectural Overview</a>
					
			</h2>

						<h2 class="not-collapsible" title="Generating ink content">

								<a href="../../general-concepts/path-building/index.html"
											>Generating ink content</a>
					
			</h2>

						<h2 class="not-collapsible" title="Rendering ink content">

								<a href="../../general-concepts/rasterizer/index.html"
											>Rendering ink content</a>
					
			</h2>

						<h2 class="not-collapsible" title="Encoding and decoding ink content">

								<a href="../../general-concepts/serialization/index.html"
											>Encoding and decoding ink content</a>
					
			</h2>

						<h2 class="not-collapsible" title="Exchanging ink content">

								<a href="../../general-concepts/file-format/index.html"
											>Exchanging ink content</a>
					
			</h2>

							</div>
							<h1 title="Web SDK">

			Web SDK
			</h1>

							<div>
					<h2 title="Getting started">

								<a href="../getting-started/index.html"
											>Getting started</a>
					
			</h2>

						<h2 title="Release Notes">

								<a href="../release-notes/index.html"
											>Release Notes</a>
					
			</h2>

						<h2 title="Tutorials">

								<a href="../tutorials-overview/index.html"
											>Tutorials</a>
					
			</h2>

							<div>
					<h3 title="Tutorial 1: Drawing with pointing devices">

								<a href="../tutorials-tutorial1/index.html"
											>Tutorial 1: Drawing with pointing devices</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Setting up the ink engine">

								<a href="../tutorials-tutorial1-part1/index.html"
											>Part 1: Setting up the ink engine</a>
					
			</h4>

						<h4 title="Part 2: Building paths from pointer input">

								<a href="../tutorials-tutorial1-part2/index.html"
											>Part 2: Building paths from pointer input</a>
					
			</h4>

						<h4 title="Part 3: Smoothing paths">

								<a href="../tutorials-tutorial1-part3/index.html"
											>Part 3: Smoothing paths</a>
					
			</h4>

						<h4 title="Part 4: Drawing preliminary paths">

								<a href="../tutorials-tutorial1-part4/index.html"
											>Part 4: Drawing preliminary paths</a>
					
			</h4>

						<h4 title="Part 5: Drawing semi-transparent strokes">

								<a href="../tutorials-tutorial1-part5/index.html"
											>Part 5: Drawing semi-transparent strokes</a>
					
			</h4>

						<h4 title="Part 6: Using a particle brush">

								<a href="../tutorials-tutorial1-part6/index.html"
											>Part 6: Using a particle brush</a>
					
			</h4>

						<h4 title="Part 7: Generating a Bezier path">

								<a href="../tutorials-tutorial1-part7/index.html"
											>Part 7: Generating a Bezier path</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 2: Encoding and decoding strokes">

								<a href="../tutorials-tutorial2/index.html"
											>Tutorial 2: Encoding and decoding strokes</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Creating a stroke model">

								<a href="../tutorials-tutorial2-part1/index.html"
											>Part 1: Creating a stroke model</a>
					
			</h4>

						<h4 title="Part 2: Serializing and deserializing strokes">

								<a href="index.html"
						 class="selected"					>Part 2: Serializing and deserializing strokes</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 3: Erasing strokes">

								<a href="../tutorials-tutorial3/index.html"
											>Tutorial 3: Erasing strokes</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Creating an eraser">

								<a href="../tutorials-tutorial3-part1/index.html"
											>Part 1: Creating an eraser</a>
					
			</h4>

						<h4 title="Part 2: Erasing parts of strokes">

								<a href="../tutorials-tutorial3-part2/index.html"
											>Part 2: Erasing parts of strokes</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 4: Selecting strokes">

								<a href="../tutorials-tutorial4/index.html"
											>Tutorial 4: Selecting strokes</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Selecting strokes">

								<a href="../tutorials-tutorial4-part1/index.html"
											>Part 1: Selecting strokes</a>
					
			</h4>

						<h4 title="Part 2: Selecting parts of strokes">

								<a href="../tutorials-tutorial4-part2/index.html"
											>Part 2: Selecting parts of strokes</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 5: Working with rasters">

								<a href="../tutorials-tutorial5/index.html"
											>Tutorial 5: Working with rasters</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Displaying raster images">

								<a href="../tutorials-tutorial5-part1/index.html"
											>Part 1: Displaying raster images</a>
					
			</h4>

						<h4 title="Part 2: Creating image masks">

								<a href="../tutorials-tutorial5-part2/index.html"
											>Part 2: Creating image masks</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 6: Collaborating in real time">

								<a href="../tutorials-tutorial6/index.html"
											>Tutorial 6: Collaborating in real time</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Composing strokes">

								<a href="../tutorials-tutorial6-part1/index.html"
											>Part 1: Composing strokes</a>
					
			</h4>

						<h4 title="Part 2: Erasing strokes">

								<a href="../tutorials-tutorial6-part2/index.html"
											>Part 2: Erasing strokes</a>
					
			</h4>

						<h4 title="Part 3: Erasing parts of strokes">

								<a href="../tutorials-tutorial6-part3/index.html"
											>Part 3: Erasing parts of strokes</a>
					
			</h4>

						<h4 title="Part 4: Selecting strokes">

								<a href="../tutorials-tutorial6-part4/index.html"
											>Part 4: Selecting strokes</a>
					
			</h4>

						<h4 title="Part 5: Selecting parts of strokes">

								<a href="../tutorials-tutorial6-part5/index.html"
											>Part 5: Selecting parts of strokes</a>
					
			</h4>

						<h4 title="Part 6: Composing strokes with latency">

								<a href="../tutorials-tutorial6-part6/index.html"
											>Part 6: Composing strokes with latency</a>
					
			</h4>

							</div>
								</div>
							<h2 title="API Reference">

			API Reference
			</h2>

							<div>
					<h3 title="Classes">

			Classes
			</h3>

							<div>
					<h4 title="BezierPath">

								<a href="../../web-api/Module.BezierPath/index.html"
											>BezierPath</a>
					
			</h4>

						<h4 title="BrushDecoder">

								<a href="../../web-api/Module.BrushDecoder/index.html"
											>BrushDecoder</a>
					
			</h4>

						<h4 title="BrushEncoder">

								<a href="../../web-api/Module.BrushEncoder/index.html"
											>BrushEncoder</a>
					
			</h4>

						<h4 title="DirectBrush">

								<a href="../../web-api/Module.DirectBrush/index.html"
											>DirectBrush</a>
					
			</h4>

						<h4 title="FlatPath">

								<a href="../../web-api/Module.FlatPath/index.html"
											>FlatPath</a>
					
			</h4>

						<h4 title="GenericLayer">

								<a href="../../web-api/Module.GenericLayer/index.html"
											>GenericLayer</a>
					
			</h4>

						<h4 title="GenericPath">

								<a href="../../web-api/Module.GenericPath/index.html"
											>GenericPath</a>
					
			</h4>

						<h4 title="InkCanvas">

								<a href="../../web-api/Module.InkCanvas/index.html"
											>InkCanvas</a>
					
			</h4>

						<h4 title="InkDecoder">

								<a href="../../web-api/Module.InkDecoder/index.html"
											>InkDecoder</a>
					
			</h4>

						<h4 title="InkEncoder">

								<a href="../../web-api/Module.InkEncoder/index.html"
											>InkEncoder</a>
					
			</h4>

						<h4 title="Intersector">

								<a href="../../web-api/Module.Intersector/index.html"
											>Intersector</a>
					
			</h4>

						<h4 title="MultiChannelSmoothener">

								<a href="../../web-api/Module.MultiChannelSmoothener/index.html"
											>MultiChannelSmoothener</a>
					
			</h4>

						<h4 title="OffscreenLayer">

								<a href="../../web-api/Module.OffscreenLayer/index.html"
											>OffscreenLayer</a>
					
			</h4>

						<h4 title="ParticleBrush">

								<a href="../../web-api/Module.ParticleBrush/index.html"
											>ParticleBrush</a>
					
			</h4>

						<h4 title="PathBuilder">

								<a href="../../web-api/Module.PathBuilder/index.html"
											>PathBuilder</a>
					
			</h4>

						<h4 title="PathContext">

								<a href="../../web-api/Module.PathContext/index.html"
											>PathContext</a>
					
			</h4>

						<h4 title="PathOperationDecoder">

								<a href="../../web-api/Module.PathOperationDecoder/index.html"
											>PathOperationDecoder</a>
					
			</h4>

						<h4 title="PathOperationEncoder">

								<a href="../../web-api/Module.PathOperationEncoder/index.html"
											>PathOperationEncoder</a>
					
			</h4>

						<h4 title="PressurePathBuilder">

								<a href="../../web-api/Module.PressurePathBuilder/index.html"
											>PressurePathBuilder</a>
					
			</h4>

						<h4 title="SolidColorBrush">

								<a href="../../web-api/Module.SolidColorBrush/index.html"
											>SolidColorBrush</a>
					
			</h4>

						<h4 title="SpeedPathBuilder">

								<a href="../../web-api/Module.SpeedPathBuilder/index.html"
											>SpeedPathBuilder</a>
					
			</h4>

						<h4 title="Stroke">

								<a href="../../web-api/Module.Stroke/index.html"
											>Stroke</a>
					
			</h4>

						<h4 title="StrokeBrush">

								<a href="../../web-api/Module.StrokeBrush/index.html"
											>StrokeBrush</a>
					
			</h4>

						<h4 title="StrokeDrawContext">

								<a href="../../web-api/Module.StrokeDrawContext/index.html"
											>StrokeDrawContext</a>
					
			</h4>

						<h4 title="StrokeRenderer">

								<a href="../../web-api/Module.StrokeRenderer/index.html"
											>StrokeRenderer</a>
					
			</h4>

							</div>
							<h3 title="Interfaces">

			Interfaces
			</h3>

							<div>
					<h4 title="PathOperationDecoderCallbacksHandlerInterface">

								<a href="../../web-api/Module.PathOperationDecoderCallbacksHandlerInterface/index.html"
											>PathOperationDecoderCallbacksHandlerInterface</a>
					
			</h4>

							</div>
							<h3 title="Namespaces">

			Namespaces
			</h3>

							<div>
					<h4 title="Module">

								<a href="../../web-api/Module/index.html"
											>Module</a>
					
			</h4>

						<h4 title="Module.Color">

								<a href="../../web-api/Module.Color/index.html"
											>Module.Color</a>
					
			</h4>

						<h4 title="Module.GLTools">

								<a href="../../web-api/Module.GLTools/index.html"
											>Module.GLTools</a>
					
			</h4>

						<h4 title="Module.MatTools">

								<a href="../../web-api/Module.MatTools/index.html"
											>Module.MatTools</a>
					
			</h4>

						<h4 title="Module.RectTools">

								<a href="../../web-api/Module.RectTools/index.html"
											>Module.RectTools</a>
					
			</h4>

							</div>
							<h3 title="Global">

								<a href="../../web-api/global/index.html"
											>Global</a>
					
			</h3>

			
	</nav>
</div><div id="page_content" class='page-content tutorials web'>
	<div class="seealso"><h2>See Also</h2><p>For more information, see the following topic:</p><ul><li><a href="../../general-concepts/serialization/index.html">Encoding and decoding ink content</a></li></ul></div>
<div id="post-54" class="page">
	<h1>Encoding and decoding strokes</h1>
<h2>Part 2: Serializing and deserializing strokes</h2>
<p>In <a href="../tutorials-tutorial2-part1/index.html">Part 1</a> of this tutorial, you created the stroke model. In Part 2 of this tutorial, you will encode strokes into a file and decode strokes from a file.</p>
<h3>Step 1: Extend the stroke model to assist the encoding process</h3>
<p>Extend the stroke model with the following methods. These methods will help you in the encoding and decoding process.</p>
<p>In the stroke constructor, initialize the stroke rect and its segments. A segment is the curve between every two control points. The WILL engine provides methods to calculate segments, but you must store them in the stroke model. The stroke rect needs to redraw only the stroke area, because it is more efficient than redrawing the entire canvas.</p>
<p>Extend the stroke model as follows:</p>
<pre><code class="javascript">function Stroke(brush, points, stride, width, color, ts, tf, randomSeed, blendMode) {
    ...

    this.initRect();
}

Stroke.prototype = {
    initRect: function() {
        this.rect = null;
        this.segments = new Array();

        this.usePoints(function(strokePoints) {
            for (var i = 0; i &lt; this.getSegmentsCount(); i++) {
                var segmentRect = this.getSegmentRect(strokePoints, i);

                if (segmentRect) {
                    this.segments.push(segmentRect);
                    this.rect = Module.RectTools.union(this.rect, segmentRect);
                }
            }
        });

        if (this.rect.left &lt; 0) {
            this.rect.width += this.rect.left;
            this.rect.left = 0;
        }

        if (this.rect.top &lt; 0) {
            this.rect.height += this.rect.top;
            this.rect.top = 0;
        }
    },

    getSegmentRect: function(strokePoints, idx) {
        var result;

        if (idx &lt; this.getSegmentsCount())
            result = Module.calculateSegmentBounds(strokePoints, this.stride, this.width, idx, 0.0);

        return result;
    },

    getSegmentsCount: function() {
        return this.getPointsCount() - 3;
    },

    getPointsCount: function() {
        return this.points.length / this.stride;
    },

    usePoints: function(callback, transformSegments) {
        var segments;

        if (transformSegments) {
            segments = new Array();

            this.segments.forEach(function(segment) {
                segments.push(segment.left);
                segments.push(segment.top);
                segments.push(segment.width);
                segments.push(segment.height);
            });
        }

        Module.useVectoredFloat32Array(callback, this, this.points, segments);
    },

};</code></pre>
<p><strong>Note:</strong> You might ask why the <code>getSegmentsCount</code> method returns <em>pointsCount - 3</em>. It does so because of the Catmull-Rom spline that defines the path of the stroke. The spline needs four points to define a single curve (segment). Because four points define one segment, each additional point after the first three adds a new segment (consisting of the new point plus the previous three control points).</p>
<h3>Step 2: Add a method to save encoded strokes</h3>
<p>Stroke encoding happens with an instance of the <a href="../../web-api/Module.InkEncoder/index.html">Module.InkEncoder</a> class.
This class encodes every stroke from the <code>strokes</code> container that you created in <a href="../tutorials-tutorial2-part1/index.html">Part 1</a> of this tutorial.</p>
<p>When the encoding is completed, deallocate the encoder using the <code>encoder.delete</code> method.</p>
<p>In the basic WILL configuration, add a method to save encoded strokes as follows:</p>
<pre><code class="javascript">save: function() {
    var data = Module.InkEncoder.encode(this.strokes);
    saveAs(data, "export.data", "application/octet-stream");
}</code></pre>
<h3>Step 3: Add a method to load encoded strokes</h3>
<p>Decoding happens with an instance of the <a href="../../web-api/Module.InkDecoder/index.html">Module.InkDecoder</a> class.
While decoding, put decoded strokes into the <code>strokes</code> container that you created in <a href="../tutorials-tutorial2-part1/index.html">Part 1</a> of this tutorial.
When the decoding process is complete, you will draw these strokes to the canvas.</p>
<p>In the basic WILL configuration, add a method to decode strokes and store them in the <code>strokes</code> container as follows:</p>
<pre><code class="javascript">load: function(e) {
    var input = e.currentTarget;
    var file = input.files[0];
    var reader = new FileReader();

    reader.onload = function(e) {
        WILL.clear();

        var strokes = Module.InkDecoder.decode(new Uint8Array(e.target.result));
        WILL.strokes.pushArray(strokes);
        WILL.redraw(strokes.bounds);
    };

    reader.readAsArrayBuffer(file);
}</code></pre>
<h3>Step 4: Add a method to redraw the stored strokes</h3>
<p>At the end of decoding, you will call a method to draw the strokes to the canvas using the <code>strokeRenderer</code> class.</p>
<p>In the basic WILL configuration, add a method to redraw the stored strokes as follows:</p>
<pre><code class="javascript">redraw: function(dirtyArea) {
    if (!dirtyArea) dirtyArea = this.canvas.bounds;
    dirtyArea = Module.RectTools.ceil(dirtyArea);

    this.strokesLayer.clear(dirtyArea);

    this.strokes.forEach(function(stroke) {
        var affectedArea = Module.RectTools.intersect(stroke.bounds, dirtyArea);

        if (affectedArea) {
            this.strokeRenderer.draw(stroke);
            this.strokeRenderer.blendStroke(this.strokesLayer, stroke.blendMode);
        }
    }, this);

        this.refresh(dirtyArea);
}</code></pre>
<h3>Step 5: Add a method to blend existing strokes with the canvas</h3>
<p>Blend the <code>strokesLayer</code> object with the current canvas.</p>
<p>In the basic WILL configuration, add a method to refresh the canvas, as follows:</p>
<pre><code class="javascript">refresh: function(dirtyArea) {
    this.canvas.blend(this.strokesLayer, {rect: Module.RectTools.ceil(dirtyArea)});
}</code></pre>
<h3>Step 6: Update the initialization</h3>
<p>The <code>Module.InkDecoder.getStrokeBrush</code> method is an abstract method. You must implement it because it is used by the <code>Module.InkDecoder.decode</code> method.
The <code>paint</code> parameter should be of type <em>uint32</em> and represent a reference to the required brush. This reference can be, for example, an array index or an ID from a custom scheme.
It is not required for serialization but can be used when an application uses multiple brushes. The implementation provided in the example code is as simple as possible.</p>
<p>The completed code for this part of the tutorial is as follows:</p>
<pre><code class="javascript">var WILL = {
    ...

    init: function(width, height) {...},
    initInkEngine: function(width, height) {...},
    initEvents: function() {...},
    beginStroke: function(e) {...},
    moveStroke: function(e) {...},
    endStroke: function(e) {...},
    buildPath: function(pos) {...},
    drawPath: function() {...},

    redraw: function(dirtyArea) {
        if (!dirtyArea) dirtyArea = this.canvas.bounds;
        dirtyArea = Module.RectTools.ceil(dirtyArea);

        this.strokesLayer.clear(dirtyArea);

        this.strokes.forEach(function(stroke) {
            var affectedArea = Module.RectTools.intersect(stroke.bounds, dirtyArea);

            if (affectedArea) {
                this.strokeRenderer.draw(stroke);
                this.strokeRenderer.blendStroke(this.strokesLayer, stroke.blendMode);
            }
        }, this);

        this.refresh(dirtyArea);
    },

    refresh: function(dirtyArea) {
        this.canvas.blend(this.strokesLayer, {rect: Module.RectTools.ceil(dirtyArea)});
    },

    clear: function() {...},

    load: function(e) {
        var input = e.currentTarget;
        var file = input.files[0];
        var reader = new FileReader();

        reader.onload = function(e) {
            WILL.clear();

            var strokes = Module.InkDecoder.decode(new Uint8Array(e.target.result));
            WILL.strokes.pushArray(strokes);
            WILL.redraw(strokes.bounds);
        };

        reader.readAsArrayBuffer(file);
    },

    save: function() {
        var data = Module.InkEncoder.encode(this.strokes);
        saveAs(data, "export.data", "application/octet-stream");
    }
};

Module.addPostScript(function() {
    Module.InkDecoder.getStrokeBrush = function(paint) {
        return WILL.brush;
    }

    ...
});</code></pre>
<p><strong>Note:</strong> For the sake of clarity, method implementations from earlier in this tutorial are replaced with <code>...</code> in the example code above.</p>
<h2>View sample</h2>
<ul>
<li><a href="http://localhost/will_docs_instance1/web/tutorials/Sample2/part2.js">View complete source code</a></li>
<li><a href="../tutorials/Sample2/Part2.html">View sample</a></li>
</ul>
<h2>Next steps</h2>
<p>At this point, you can progress to <a href="../tutorials-tutorial3/index.html">Tutorial 3: Erasing strokes</a>.</p>
</div> <!-- page -->
			<nav class="prev-next-page">
									<a href="../tutorials-tutorial2-part1/index.html" class="prev-page">&laquo; Creating a stroke model</a>
								</nav>
			</div> <!-- page_content -->

	</div><!-- #sitewrapper -->

	<footer>
		<img src="../../wp-content/themes/will-doc/images/img_logo_wacom.png" alt="" />
<!--
		<span>&nbsp;</span>
		<a href="/contact.html">Contact</a>
		<a href="/support.html">Support</a>
-->
	</footer>
</body>
</html>