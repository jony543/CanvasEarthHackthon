<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) & !(IE 8)]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Composing strokes with latency | WILL SDK Docs</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="http://localhost/will_docs_instance1/xmlrpc.php">
	<!--[if lt IE 9]>
	<script src="http://localhost/will_docs_instance1/wp-content/themes/will-doc/js/html5.js"></script>
	<![endif]-->

	<link rel="stylesheet" href="../../wp-content/themes/will-doc/css/style.css">
	<link rel="stylesheet" href="../../wp-content/themes/will-doc/css/accordionmenu.css">

	<script src="../../wp-content/themes/will-doc/js/jquery.min.js"></script>
	<script src="../../wp-content/themes/will-doc/js/sidebar.js"></script>

	<link rel="stylesheet" href="../../wp-content/themes/will-doc/css/highlight.css">
	<script src="../../wp-content/themes/will-doc/js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
	<header>
		<div class="title">
			<div>WILL &trade;</div>
			<div>sdk documentation</div>
		</div>
		<!--
		<div id="searchbox">
			<input class="typeahead" type="text" placeholder="{{ search_text }}">
		</div>
-->
	</header>

	<div id="sitewrapper">
<div id="sidebar">
	<nav class="accordion">

				<h1 class="do-not-cause-collapse" title="General Concepts">

			General Concepts
			</h1>

							<div class="active-menu never-close">
					<h2 class="not-collapsible" title="Architectural Overview">

								<a href="../../general-concepts/architecture/index.html"
											>Architectural Overview</a>
					
			</h2>

						<h2 class="not-collapsible" title="Generating ink content">

								<a href="../../general-concepts/path-building/index.html"
											>Generating ink content</a>
					
			</h2>

						<h2 class="not-collapsible" title="Rendering ink content">

								<a href="../../general-concepts/rasterizer/index.html"
											>Rendering ink content</a>
					
			</h2>

						<h2 class="not-collapsible" title="Encoding and decoding ink content">

								<a href="../../general-concepts/serialization/index.html"
											>Encoding and decoding ink content</a>
					
			</h2>

						<h2 class="not-collapsible" title="Exchanging ink content">

								<a href="../../general-concepts/file-format/index.html"
											>Exchanging ink content</a>
					
			</h2>

							</div>
							<h1 title="Web SDK">

			Web SDK
			</h1>

							<div>
					<h2 title="Getting started">

								<a href="../getting-started/index.html"
											>Getting started</a>
					
			</h2>

						<h2 title="Release Notes">

								<a href="../release-notes/index.html"
											>Release Notes</a>
					
			</h2>

						<h2 title="Tutorials">

								<a href="../tutorials-overview/index.html"
											>Tutorials</a>
					
			</h2>

							<div>
					<h3 title="Tutorial 1: Drawing with pointing devices">

								<a href="../tutorials-tutorial1/index.html"
											>Tutorial 1: Drawing with pointing devices</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Setting up the ink engine">

								<a href="../tutorials-tutorial1-part1/index.html"
											>Part 1: Setting up the ink engine</a>
					
			</h4>

						<h4 title="Part 2: Building paths from pointer input">

								<a href="../tutorials-tutorial1-part2/index.html"
											>Part 2: Building paths from pointer input</a>
					
			</h4>

						<h4 title="Part 3: Smoothing paths">

								<a href="../tutorials-tutorial1-part3/index.html"
											>Part 3: Smoothing paths</a>
					
			</h4>

						<h4 title="Part 4: Drawing preliminary paths">

								<a href="../tutorials-tutorial1-part4/index.html"
											>Part 4: Drawing preliminary paths</a>
					
			</h4>

						<h4 title="Part 5: Drawing semi-transparent strokes">

								<a href="../tutorials-tutorial1-part5/index.html"
											>Part 5: Drawing semi-transparent strokes</a>
					
			</h4>

						<h4 title="Part 6: Using a particle brush">

								<a href="../tutorials-tutorial1-part6/index.html"
											>Part 6: Using a particle brush</a>
					
			</h4>

						<h4 title="Part 7: Generating a Bezier path">

								<a href="../tutorials-tutorial1-part7/index.html"
											>Part 7: Generating a Bezier path</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 2: Encoding and decoding strokes">

								<a href="../tutorials-tutorial2/index.html"
											>Tutorial 2: Encoding and decoding strokes</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Creating a stroke model">

								<a href="../tutorials-tutorial2-part1/index.html"
											>Part 1: Creating a stroke model</a>
					
			</h4>

						<h4 title="Part 2: Serializing and deserializing strokes">

								<a href="../tutorials-tutorial2-part2/index.html"
											>Part 2: Serializing and deserializing strokes</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 3: Erasing strokes">

								<a href="../tutorials-tutorial3/index.html"
											>Tutorial 3: Erasing strokes</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Creating an eraser">

								<a href="../tutorials-tutorial3-part1/index.html"
											>Part 1: Creating an eraser</a>
					
			</h4>

						<h4 title="Part 2: Erasing parts of strokes">

								<a href="../tutorials-tutorial3-part2/index.html"
											>Part 2: Erasing parts of strokes</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 4: Selecting strokes">

								<a href="../tutorials-tutorial4/index.html"
											>Tutorial 4: Selecting strokes</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Selecting strokes">

								<a href="../tutorials-tutorial4-part1/index.html"
											>Part 1: Selecting strokes</a>
					
			</h4>

						<h4 title="Part 2: Selecting parts of strokes">

								<a href="../tutorials-tutorial4-part2/index.html"
											>Part 2: Selecting parts of strokes</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 5: Working with rasters">

								<a href="../tutorials-tutorial5/index.html"
											>Tutorial 5: Working with rasters</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Displaying raster images">

								<a href="../tutorials-tutorial5-part1/index.html"
											>Part 1: Displaying raster images</a>
					
			</h4>

						<h4 title="Part 2: Creating image masks">

								<a href="../tutorials-tutorial5-part2/index.html"
											>Part 2: Creating image masks</a>
					
			</h4>

							</div>
							<h3 title="Tutorial 6: Collaborating in real time">

								<a href="../tutorials-tutorial6/index.html"
											>Tutorial 6: Collaborating in real time</a>
					
			</h3>

							<div>
					<h4 title="Part 1: Composing strokes">

								<a href="../tutorials-tutorial6-part1/index.html"
											>Part 1: Composing strokes</a>
					
			</h4>

						<h4 title="Part 2: Erasing strokes">

								<a href="../tutorials-tutorial6-part2/index.html"
											>Part 2: Erasing strokes</a>
					
			</h4>

						<h4 title="Part 3: Erasing parts of strokes">

								<a href="../tutorials-tutorial6-part3/index.html"
											>Part 3: Erasing parts of strokes</a>
					
			</h4>

						<h4 title="Part 4: Selecting strokes">

								<a href="../tutorials-tutorial6-part4/index.html"
											>Part 4: Selecting strokes</a>
					
			</h4>

						<h4 title="Part 5: Selecting parts of strokes">

								<a href="../tutorials-tutorial6-part5/index.html"
											>Part 5: Selecting parts of strokes</a>
					
			</h4>

						<h4 title="Part 6: Composing strokes with latency">

								<a href="index.html"
						 class="selected"					>Part 6: Composing strokes with latency</a>
					
			</h4>

							</div>
								</div>
							<h2 title="API Reference">

			API Reference
			</h2>

							<div>
					<h3 title="Classes">

			Classes
			</h3>

							<div>
					<h4 title="BezierPath">

								<a href="../../web-api/Module.BezierPath/index.html"
											>BezierPath</a>
					
			</h4>

						<h4 title="BrushDecoder">

								<a href="../../web-api/Module.BrushDecoder/index.html"
											>BrushDecoder</a>
					
			</h4>

						<h4 title="BrushEncoder">

								<a href="../../web-api/Module.BrushEncoder/index.html"
											>BrushEncoder</a>
					
			</h4>

						<h4 title="DirectBrush">

								<a href="../../web-api/Module.DirectBrush/index.html"
											>DirectBrush</a>
					
			</h4>

						<h4 title="FlatPath">

								<a href="../../web-api/Module.FlatPath/index.html"
											>FlatPath</a>
					
			</h4>

						<h4 title="GenericLayer">

								<a href="../../web-api/Module.GenericLayer/index.html"
											>GenericLayer</a>
					
			</h4>

						<h4 title="GenericPath">

								<a href="../../web-api/Module.GenericPath/index.html"
											>GenericPath</a>
					
			</h4>

						<h4 title="InkCanvas">

								<a href="../../web-api/Module.InkCanvas/index.html"
											>InkCanvas</a>
					
			</h4>

						<h4 title="InkDecoder">

								<a href="../../web-api/Module.InkDecoder/index.html"
											>InkDecoder</a>
					
			</h4>

						<h4 title="InkEncoder">

								<a href="../../web-api/Module.InkEncoder/index.html"
											>InkEncoder</a>
					
			</h4>

						<h4 title="Intersector">

								<a href="../../web-api/Module.Intersector/index.html"
											>Intersector</a>
					
			</h4>

						<h4 title="MultiChannelSmoothener">

								<a href="../../web-api/Module.MultiChannelSmoothener/index.html"
											>MultiChannelSmoothener</a>
					
			</h4>

						<h4 title="OffscreenLayer">

								<a href="../../web-api/Module.OffscreenLayer/index.html"
											>OffscreenLayer</a>
					
			</h4>

						<h4 title="ParticleBrush">

								<a href="../../web-api/Module.ParticleBrush/index.html"
											>ParticleBrush</a>
					
			</h4>

						<h4 title="PathBuilder">

								<a href="../../web-api/Module.PathBuilder/index.html"
											>PathBuilder</a>
					
			</h4>

						<h4 title="PathContext">

								<a href="../../web-api/Module.PathContext/index.html"
											>PathContext</a>
					
			</h4>

						<h4 title="PathOperationDecoder">

								<a href="../../web-api/Module.PathOperationDecoder/index.html"
											>PathOperationDecoder</a>
					
			</h4>

						<h4 title="PathOperationEncoder">

								<a href="../../web-api/Module.PathOperationEncoder/index.html"
											>PathOperationEncoder</a>
					
			</h4>

						<h4 title="PressurePathBuilder">

								<a href="../../web-api/Module.PressurePathBuilder/index.html"
											>PressurePathBuilder</a>
					
			</h4>

						<h4 title="SolidColorBrush">

								<a href="../../web-api/Module.SolidColorBrush/index.html"
											>SolidColorBrush</a>
					
			</h4>

						<h4 title="SpeedPathBuilder">

								<a href="../../web-api/Module.SpeedPathBuilder/index.html"
											>SpeedPathBuilder</a>
					
			</h4>

						<h4 title="Stroke">

								<a href="../../web-api/Module.Stroke/index.html"
											>Stroke</a>
					
			</h4>

						<h4 title="StrokeBrush">

								<a href="../../web-api/Module.StrokeBrush/index.html"
											>StrokeBrush</a>
					
			</h4>

						<h4 title="StrokeDrawContext">

								<a href="../../web-api/Module.StrokeDrawContext/index.html"
											>StrokeDrawContext</a>
					
			</h4>

						<h4 title="StrokeRenderer">

								<a href="../../web-api/Module.StrokeRenderer/index.html"
											>StrokeRenderer</a>
					
			</h4>

							</div>
							<h3 title="Interfaces">

			Interfaces
			</h3>

							<div>
					<h4 title="PathOperationDecoderCallbacksHandlerInterface">

								<a href="../../web-api/Module.PathOperationDecoderCallbacksHandlerInterface/index.html"
											>PathOperationDecoderCallbacksHandlerInterface</a>
					
			</h4>

							</div>
							<h3 title="Namespaces">

			Namespaces
			</h3>

							<div>
					<h4 title="Module">

								<a href="../../web-api/Module/index.html"
											>Module</a>
					
			</h4>

						<h4 title="Module.Color">

								<a href="../../web-api/Module.Color/index.html"
											>Module.Color</a>
					
			</h4>

						<h4 title="Module.GLTools">

								<a href="../../web-api/Module.GLTools/index.html"
											>Module.GLTools</a>
					
			</h4>

						<h4 title="Module.MatTools">

								<a href="../../web-api/Module.MatTools/index.html"
											>Module.MatTools</a>
					
			</h4>

						<h4 title="Module.RectTools">

								<a href="../../web-api/Module.RectTools/index.html"
											>Module.RectTools</a>
					
			</h4>

							</div>
							<h3 title="Global">

								<a href="../../web-api/global/index.html"
											>Global</a>
					
			</h3>

			
	</nav>
</div><div id="page_content" class='page-content tutorials web'>
	
<div id="post-71" class="page">
	<h1>Collaborating in real time</h1>
<h2>Part 6: Composing strokes with latency</h2>
<p>This part builds on the composition of strokes from <a href="../tutorials-tutorial6-part1/index.html">Part 1</a> of this tutorial. The example is similar, but operations occur with some delay in this part.</p>
<p>In a real scenario, this latency depends on the network and is related with its bandwith.
Composition happens instantly on the user's canvas, but the stroke enters the stroke model only when the server confirms it.</p>
<p>In Part 6 of this tutorial, you will enable multiple stroke creators and transfer stroke data over the network with simulated latency.</p>
<h3>Step 1: Update the stroke composition process to track active users</h3>
<p>The initialization process and writer definition are unchanged from <a href="../tutorials-tutorial6-part1/index.html">Part 1</a> of this tutorial.</p>
<p>Update the WILL configuration as follows:</p>
<pre><code class="javascript">var WILL = {
    ...
    activeWriters: new Array(),

    init: function(width, height) {...},
    initInkEngine: function(width, height) {...},
    initEvents: function() {...},

    beginStroke: function(e) {
        ...

        client.encoder.encodeComposeStyle(this.writer.strokeRenderer);
        client.send();

        this.activeWriters.add(this.writer);

        ...
    },

    moveStroke: function(e) {...},
    endStroke: function(e) {...},
    buildPath: function(pos) {...},
    drawPath: function() {...},

    redraw: function(dirtyArea) {
        if (!dirtyArea) dirtyArea = this.canvas.bounds;
        dirtyArea = Module.RectTools.ceil(dirtyArea);

        this.strokesLayer.clear(dirtyArea);

        this.strokes.forEach(function(stroke) {
            var affectedArea = Module.RectTools.intersect(stroke.bounds, dirtyArea);

            if (affectedArea) {
                this.writer.strokeRenderer.draw(stroke);
                this.writer.strokeRenderer.blendStroke(this.strokesLayer, stroke.blendMode);
            }
        }, this);

        this.refresh(dirtyArea);
    },

    refresh: function (dirtyArea, redraw) {
        if (this.activeWriters.length == 0) {
            if (redraw)
                this.redraw(dirtyArea);
            else
                this.refreshCanvas(dirtyArea);

            return;
        }

        if (this.activeArea)
            this.activeArea = Module.RectTools.union(this.activeArea, dirtyArea);
        else
            this.activeArea = dirtyArea || this.viewArea;

        if (redraw)
            this.activeArea.redraw = true;

        if (!this.refreshTimeoutID) {
            this.refreshTimeoutID = setTimeout(function() {
                var activeArea = WILL.activeArea;
                delete WILL.activeArea;

                if (activeArea.redraw)
                    WILL.redraw(activeArea);
                else
                    WILL.refreshCanvas(activeArea);

                delete WILL.refreshTimeoutID;
                if (WILL.activeArea) WILL.refresh(WILL.activeArea);
            }, 16);
        }
    },

    refreshCanvas: function(dirtyArea) {
        if (!dirtyArea) dirtyArea = this.canvas.bounds;
        dirtyArea = Module.RectTools.ceil(dirtyArea);

        if (this.activeWriters.length &gt; 0) {
            if (this.writer.inputPhase &amp;&amp; this.writer.inputPhase == Module.InputPhase.Move)
                this.writer.strokeRenderer.drawPreliminary(this.preliminaryPathPart);

            this.canvas.clear(dirtyArea, this.backgroundColor);
            this.canvas.blend(this.strokesLayer, {rect: dirtyArea});

            this.activeWriters.forEach(function(writer) {
                writer.strokeRenderer.updatedArea = dirtyArea;
                writer.strokeRenderer.blendUpdatedArea();

                writer.unconfirmedStrokesData.forEach(function(data) {
                    this.canvas.blend(data.layer, {mode: data.blendMode, rect: dirtyArea});
                }, this);
            }, this);
        }
        else {
            this.canvas.clear(dirtyArea, this.backgroundColor);
            this.canvas.blend(this.strokesLayer, {rect: dirtyArea});
        }
    },

    clearCanvas: function() {...},
    restore: function(fileBuffer) {...}
};</code></pre>
<p>WILL defines the <code>activeWriters</code> property, which is an array that contains all users who collaborate on the canvas.
In this example, the incoming writer is stored as an element in the <code>activeWriters</code> array.</p>
<p>In the <code>beginStroke</code> method, the writer becomes active. However, the writer is not removed from the <code>activeWriters</code> array in the <code>endStroke</code> method.
A writer becomes inactive only when the stroke is confirmed. This confirmation occurs when the <code>onAdd</code> event fires.
When the server confirms a stroke, the stroke data is removed from the <code>unconfirmedStrokesData</code> array (which you will create in step 2).
If there are no more elements in that array, and if the active writer is the current user and does not create additional strokes, the writer is removed from the <code>activeWriters</code> array.</p>
<p>When a user writes to the canvas, you need to refresh the canvas.
The <code>refresh</code> method in this example is more complicated than the <code>refresh</code> method in <a href="../tutorials-tutorial6-part1/index.html">Part 1</a>.
Here, the method defines an <code>activeArea</code> variable that contains all affected areas from the <code>strokeRenderer</code> instances of all active writers.
A benefit of this method is that it gathers the combined input from all active writers. This minimises interaction with the canvas.</p>
<p>The <code>refreshCanvas</code> method refreshes data instantly and is called from the <code>refresh</code> method.
The <code>refreshCanvas</code> method is extended with a loop through all active writers whose current input is to be displayed.
It also reads all strokes that are finished but not confirmed, because their data does not yet exist in the <code>strokesLayer</code> layer.</p>
<h3>Step 2: Define an array to store unconfirmed stroke data</h3>
<p>Define an <code>unconfirmedStrokesData</code> variable in the <code>Writer</code> constructor.
This variable must contain all layers, stroke bounds, and the blend mode from the <code>strokeRenderer</code> constructor when a user completes a stroke locally.</p>
<p>Update the <code>Writer</code> constructor as follows:</p>
<pre><code class="javascript">function Writer(id) {
    ...

    this.unconfirmedStrokesData = new Array();

    ...
}

Writer.prototype.compose = function(path, endStroke) {
    if (path.points.length == 0)
        return;

    this.strokeRenderer.draw(path, endStroke, this.id != client.id);

    if (endStroke) {
        this.unconfirmedStrokesData.push({layer: this.strokeRenderer.layer, strokeBounds: this.strokeRenderer.strokeBounds, blendMode: this.strokeRenderer.blendMode});
        this.strokeRenderer.layer = WILL.canvas.createLayer();

        delete this.inputPhase;
    }

    if (this.strokeRenderer.updatedArea)
        WILL.refresh(this.strokeRenderer.updatedArea);

    if (this.id == client.id) {
        client.encoder.encodeComposePathPart(path, this.strokeRenderer.color, true, false, endStroke);
        client.send(true);
    }
}

Writer.prototype.abort = function() {
    ...

    WILL.activeWriters.remove(this);

    ...
}</code></pre>
<h3>Step 3: Update the client to use the list of active writers</h3>
<p>Update the <code>client</code> object to use the list of active writers as follows:</p>
<pre><code class="javascript">var client = {
    ...

    init: function() {...},
    send: function(compose) {...},
    recieve: function(sender, data) {...},

    callbacksHandlerImplementation: {
        onComposeStyle: function(writer, style) {...},

        onComposePathPart: function(writer, path, endStroke) {
            if (writer.id == client.id) return;

            WILL.activeWriters.add(writer);
            writer.compose(path, endStroke);
        },

        onComposeAbort: function(writer) {...},

        onAdd: function(writer, strokes) {
            strokes.forEach(function(stroke) {
                WILL.strokes.push(stroke);

                var data = writer.unconfirmedStrokesData.shift();
                WILL.strokesLayer.blend(data.layer, {mode: data.blendMode, rect: data.strokeBounds});

                if (writer.unconfirmedStrokesData.length == 0 &amp;&amp; !writer.inputPhase)
                    WILL.activeWriters.remove(writer);

                data.layer.delete();

                WILL.refresh(data.strokeBounds, false);
            }, this);
        },

        ...
    }
};</code></pre>
<p>At the end of the <code>onAdd</code> event, the unconfirmed layer is deleted. Its memory is found in HEAP. Release this memory manually.</p>
<p><strong>Note:</strong> For the sake of clarity, method implementations from earlier in this tutorial are replaced with <code>...</code> in the example code above.</p>
<h2>View sample</h2>
<ul>
<li><a href="http://localhost/will_docs_instance1/web/tutorials/Sample6/part6.js">View complete source code</a></li>
<li><a href="../tutorials/Sample6/Part6.html">View sample</a></li>
</ul>
</div> <!-- page -->
			<nav class="prev-next-page">
									<a href="../tutorials-tutorial6-part5/index.html" class="prev-page">&laquo; Selecting parts of strokes</a>
								</nav>
			</div> <!-- page_content -->

	</div><!-- #sitewrapper -->

	<footer>
		<img src="../../wp-content/themes/will-doc/images/img_logo_wacom.png" alt="" />
<!--
		<span>&nbsp;</span>
		<a href="/contact.html">Contact</a>
		<a href="/support.html">Support</a>
-->
	</footer>
</body>
</html>